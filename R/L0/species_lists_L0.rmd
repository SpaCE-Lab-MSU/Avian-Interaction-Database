---
title: "Avian Interaction Database: L0 File Preparation"
output: 
html_notebook: default
knit: (function(inputFile, encoding) {
      out_dir <- "html";
      rmarkdown::render(inputFile,
                        encoding=encoding,
                        output_dir=file.path(dirname(inputFile), out_dir))})
---


# L0 Species Checklist Data

Pulls in raw lists from sources and creates formatted versions of lists as L0 data

- AUTHORS:        Phoebe Zarnetske
- COLLABORATORS:  Vincent Miele, Stephane Dray, Emily Parker, Pat Bills
- PROJECT:        Avian Interaction Database & avian-meta-network
- DATE:           17 January 2022 - 12 August 2025

### NOTES:          

check out this site for code w BBS: 

https://rdrr.io/github/davharris/mistnet/src/extras/BBS-analysis/data_extraction/data-extraction.R

For other types of lists check out: https://datazone.birdlife.org/search
which has data on migratory status, conservation status, etc.

bbs_specieslist_2024_L1.csv is produced in bbs_specieslist_L1_v2.R

Next script to run: bbs/bbs_specieslist_L1_v2.R

### Notes August 2025

This is an Rmarkdown/Notebook version of  what was previously used just for BBS, 
written by PLZ. See the folder R/bbs for those original scripts.  This needs review and 
should be converted to quarto as the other scripts or archived.  

This script was not used in the final workflow, but is kept for historical reference. 

PLZ created species lists used by the L0 and L1 workflows are not in this 
repository, but in the non-public "working" data repository.  



## DATA INPUT:     

Imports L0 raw species list data from:

1. Clements/eBird Cheklist v2024 (Cornell Lab of Ornithology)
2. the USGS North American Breeding Bird Survey (BBS) SpeciesList
from 2024 release (up to 2023 BBS data; SpeciesList.txt is updated yearly).
3. CA-CONUS List = AviBase Canada list + AviBase Lower 48 US +
AviBase Alaska list (taxonomy from Clements 2024 list)
4. American Birding Association (ABA) Version 8.17 Nov. 2024 list

## DATA OUTPUT:    

1. L0 Clements/eBird Cheklist v2024
2. BBS List L0 data: bbs_specieslist_2023_L0.csv 
   - this is a copy of the raw data, just omitting the top lines without data
3. CA.CONUS list L0 data: avibase_ca.conus_splist_2024_L0.csv
  - this is data pulled from the AviBase species list website and formatted
4. American Birding Association (ABA) Version 8.17 Nov. 2024 list: formatted


```{r}

# previous R-script setup for comparison
# not run

# Clear all existing data
# rm(list=ls())
# 
# # Load necessary libraries
# library(dplyr)
# library(tidyr)
# library(rvest) # for web scraping
# library(stringr)

# Define local directory
# L0_dir <- "/Users/plz/Documents/GitHub/Avian-Interaction-Database-Working/L0/species_checklists/"
```



```{r}
# suppress messages from loading packages for clean report output
suppressMessages({
  source(here::here('R/L0/L0_functions.R'))
  library(dplyr)
  library(stringr)
  }
)
# This uses functions in R/L0/L0_functions_files which also imports R/config.R
# which sets the locations of the data folders. 

file_paths <- get_file_paths() 

# Define local directory
L0_dir <- file_paths$CHECKLIST_FOLDER

```

#### (1) Clements/eBird 2024 Checklist: Cornell Lab of Ornithology

```{r}

# see Clements function in read_clements.Rmd

# clements2024<-read.csv("https://www.birds.cornell.edu/clementschecklist/wp-content/uploads/2024/10/eBird-Clements-v2024-integrated-checklist-October-2024-rev.csv")
# 
# # Export this as its original filename for final cleaning in L1 script.
# write.csv(clements2024, file.path(L0_dir,"eBird-Clements-v2024-integrated-checklist-October-2024-rev.csv"), fileEncoding="UTF-8", row.names=F)

```

```{r}
#### (2) BBS List ####
# Below section is modified from: https://rdrr.io/github/davharris/mistnet/src/extras/BBS-analysis/data_extraction/species-handling.R
# Read in the SpeciesList file:
# Reading in a copy placed in the L0 directory on October 22, 2024, and renamed BBS2024_SpeciesListL0.txt
guess_encoding(file.path(L0_dir,"bbs_splist_2022_L0.csv"))
#ISO-8859-1
bbs.splist.2023<-read.csv(file.path(L0_dir,"bbs_splist_2022_L0.csv"),fileEncoding="ISO-8859-1")
# The original file SpeciesList.csv (from 2024 BBS release) is here: https://www.sciencebase.gov/catalog/item/66d9ed16d34eef5af66d534b
guess_encoding(file.path(L0_dir,"BBS2024_SpeciesListL0.csv"))
#UTF-8
bbs.splist.2024<-read.csv(file.path(L0_dir,"BBS2024_SpeciesListL0.csv"),fileEncoding="UTF-8")

# Make a column for genus_species
bbs.splist.2024$genus_species<- do.call(paste, c(bbs.splist.2024[c("Genus", "Species")], sep = " "))
names(bbs.splist.2023)
names(bbs.splist.2024)
bbs.splist.2023$Spanish_Common_Name<-NULL
bbs.splist.2023$Order<-bbs.splist.2023$ORDER
bbs.splist.2023$ORDER<-NULL

# Make a column for genus_species
bbs.splist.2024$genus_species<- do.call(paste, c(bbs.splist.2024[c("Genus", "Species")], sep = " "))
dim(bbs.splist.2024)

```

Number of species: 

```{r}
# 763 species
```

### Compare the BBS list from last year to this year to identify changes:


 Full join on "AOU" only, ignoring extra rows in the 2024 data

```{r}
differences <- bbs.splist.2023 %>%
  full_join(bbs.splist.2024, by = "AOU", suffix = c(".2023", ".2024")) %>%
  # Use rowwise to apply comparisons across columns
  rowwise() %>%
  # Create a data frame of differing values
  mutate(
    differing_values = list(
      tibble(
        AOU = AOU,
        English_Common_Name = if_else(English_Common_Name.2023 != English_Common_Name.2024,
                                      paste(English_Common_Name.2023, "->", English_Common_Name.2024),
                                      ""),
        French_Common_Name = if_else(French_Common_Name.2023 != French_Common_Name.2024,
                                     paste(French_Common_Name.2023, "->", French_Common_Name.2024),
                                     ""),
        Order = if_else(Order.2023 != Order.2024,
                        paste(Order.2023, "->", Order.2024),
                        ""),
        Family = if_else(Family.2023 != Family.2024,
                         paste(Family.2023, "->", Family.2024),
                         ""),
        Genus = if_else(Genus.2023 != Genus.2024,
                        paste(Genus.2023, "->", Genus.2024),
                        ""),
        Species = if_else(Species.2023 != Species.2024,
                          paste(Species.2023, "->", Species.2024),
                          "")
      )
    )
  ) %>%
  # Filter for rows where any differences exist
  filter(!all(differing_values[[1]] == "")) %>%
  # Select only the relevant columns
  select(AOU, differing_values)
```


Unnest the differing values into a more readable format with unique names


```{r}
clean_differences <- differences %>%
  unnest_wider(differing_values, names_sep = "_diff")

# Print out the differences
print(clean_differences, n = Inf)

```


Export to take a look (ignore the encodings which don't match)

```{r}

write.csv(clean_differences,file.path(L0_dir,"BBS_specieslist_diffs2023-2024.csv"), fileEncoding="UTF-8", row.names=F)
```


Winter 2025: The current comparison lists these species as changing since last time:

differing_values_diffEnglish_Common_Name

- Northern Goshawk -> American Goshawk
- (unid. Red/Yellow Shafted) Northern Flicker -> (unid. Red / Yellow Shafted) Northern Flicker
- Pacific-slope Flycatcher -> (Pacific-slope Flycatcher) Western Flycatcher
- Cordilleran Flycatcher -> (Cordilleran Flycatcher) Western Flycatcher
- unid. Cordilleran / Pacific-slope Flycatcher -> (unid. Cordilleran / Pac-slope) Western Flycatcher
- Swinhoe¬ís White-eye -> Swinhoe‚Äôs White-eye
- Unid. Cassia Crossbill / Red Crossbill -> unid. Cassia Crossbill / Red Crossbill
- (unid. Myrtle/Audubon's) Yellow-rumped Warbler -> (unid. Myrtle / Audubon's) Yellow-rumped Warbler


The species re-assignment checking occurs in R/L1/AvianInteractionData_L1.qmd



Export the cleaned data (note the encoding to maintain special characters)

```{r}
write.csv(bbs.splist.2024, file.path(L0_dir,"bbs_splist_2024_L0.csv"), fileEncoding="UTF-8", row.names=F)
```

### Next script to run: bbs_specieslist_L1.R

Then, if combining with bbs_obs data: AvianInteractionData_L1.R


### (3) AviBase 8.17 CA-CONUS List ####

This list represents birds observed in Canada and the Continental United States from AviBase, using Clements 2024 taxonomy.

### **** AviBase 8.17 CANADA species ****####

https://avibase.bsc-eoc.org/checklist.jsp?lang=EN&p2=1&list=clements&synlang=&region=US48&version=text&lifelist=&highlight=0

```{r}
ca<- "https://avibase.bsc-eoc.org/checklist.jsp?lang=EN&p2=1&list=clements&synlang=&region=US48&version=text&lifelist=&highlight=0"
avi.ca.page <- read_html(ca)
```


Extract all tables and select the desired table

```{r}
ca.tables <- html_nodes(avi.ca.page, "table")
ca.table <- html_table(ca.tables[[1]], fill = TRUE)
head(ca.table) # it's the correct table

# Rename columns
ca.table <- ca.table %>%
  rename(common_name = X1, scientific_name = X2, status=X3)

# Move the order and family info to new columns
ca.table <- ca.table %>%
  mutate(
    # Capture order (all caps) and family (first letter caps) separately
    order = str_extract(common_name, "\\b[A-Z]+(?: [A-Z]+)*(?=: )"),
    family = str_extract(common_name, "(?<=: )[A-Z][a-z]+")
  ) %>%
  fill(order, family) %>%
  filter(!(common_name == paste(order, family, sep = ": ")))
ca.table

```

### **** AviBase 8.17 US Lower 48 species ****####

https://avibase.bsc-eoc.org/checklist.jsp?lang=EN&p2=1&list=clements&synlang=&region=US48&version=text&lifelist=&highlight=0

```{r}
us48<-"https://avibase.bsc-eoc.org/checklist.jsp?lang=EN&p2=1&list=clements&synlang=&region=US48&version=text&lifelist=&highlight=0"
avi.us48.page <- read_html(us48)
```


Extract all tables and select the desired table

```{r}

us48.tables <- html_nodes(avi.us48.page, "table")
us48.table <- html_table(us48.tables[[1]], fill = TRUE)
head(us48.table) # it's the correct table

# Rename columns
us48.table <- us48.table %>%
  rename(common_name = X1, scientific_name = X2, status=X3)

# Move the order and family info to new columns
us48.table <- us48.table %>%
  mutate(
    # Capture order (all caps) and family (first letter caps) separately
    order = str_extract(common_name, "\\b[A-Z]+(?: [A-Z]+)*(?=: )"),
    family = str_extract(common_name, "(?<=: )[A-Z][a-z]+")
  ) %>%
  fill(order, family) %>%
  filter(!(common_name == paste(order, family, sep = ": ")))
us48.table
```


### **** AviBase 8.17 Alaska species ****####

https://avibase.bsc-eoc.org/checklist.jsp?lang=EN&p2=1&list=clements&synlang=&region=USak&version=text&lifelist=&highlight=0

```{r}
ak<-"https://avibase.bsc-eoc.org/checklist.jsp?lang=EN&p2=1&list=clements&synlang=&region=USak&version=text&lifelist=&highlight=0"
avi.ak.page <- read_html(ak)

# Extract all tables and select the desired table
ak.tables <- html_nodes(avi.ak.page, "table")
ak.table <- html_table(ak.tables[[1]], fill = TRUE)
head(ak.table) # it's the correct table

# Rename columns
ak.table <- ak.table %>%
  rename(common_name = X1, scientific_name = X2, status=X3)

# Move the order and family info to new columns
ak.table <- ak.table %>%
  mutate(
    # Capture order (all caps) and family (first letter caps) separately
    order = str_extract(common_name, "\\b[A-Z]+(?: [A-Z]+)*(?=: )"),
    family = str_extract(common_name, "(?<=: )[A-Z][a-z]+")
  ) %>%
  fill(order, family) %>%
  filter(!(common_name == paste(order, family, sep = ": ")))
ak.table
```


### Merge CA, Lower 48, Alaska and omit duplicates.

First check that there isn't an issue with merging and finding mismatches.

```{r}

# Add region tags
ak.table   <- ak.table   %>% mutate(region = "AK")
ca.table   <- ca.table   %>% mutate(region = "CA")
us48.table <- us48.table %>% mutate(region = "US48")

# Merge all three
merged.table <- bind_rows(ak.table, ca.table, us48.table)

# Normalize whitespace in key columns
merged.table <- merged.table %>%
  mutate(
    scientific_name = str_squish(scientific_name),
    common_name     = str_squish(common_name),
    order           = str_squish(order),
    family          = str_squish(family),
    status          = str_squish(status)
  )

# Set priority: US48 first
region_priority <- c("US48", "CA", "AK")

merged.table <- merged.table %>%
  mutate(region_factor = factor(region, levels = region_priority))

# Get the preferred record per species by priority region
preferred_records <- merged.table %>%
  arrange(scientific_name, region_factor) %>%
  group_by(scientific_name) %>%
  slice(1) %>%
  ungroup() %>%
  select(-region_factor)

# Collect all unique regions per species as a concatenated string
all_regions <- merged.table %>%
  group_by(scientific_name) %>%
  summarise(
    region = paste(sort(unique(region)), collapse = "; "),
    .groups = "drop"
  )

# Join the preferred records with the collected regions
ca.conus <- preferred_records %>%
  select(-region) %>%   # drop single-region column from preferred record
  left_join(all_regions, by = "scientific_name")

cat("Number of species in ca.conus:", n_distinct(ca.conus$scientific_name), "\n")
cat("Number of rows in ca.conus:", nrow(ca.conus), "\n")
```

optionally display this file
```{r}
# ca.conus
```


Export this for final cleaning in L1 script where species are further subset.

```{r}
write.csv(ca.conus, file.path(L0_dir,"avibase_ca.conus_splist_2024_L0.csv"), fileEncoding="UTF-8", row.names=F)
```

### (4) AviBase 8.17 Hawaii,  ####


This will obtain the entire region, including outlying islands

https://avibase.bsc-eoc.org/checklist.jsp?lang=EN&p2=1&list=clements&synlang=&region=NAM&version=text&lifelist=&highlight=0

TBD

**Work on this next to pull in data from Islands in Northern & Western Hemisphere**


