---
title: "Ammend L0 stitched data"
author: 
  - Phoebe L. Zarnetske
  - Patrick Bills
  - Emily Parker
format:
  html:
    toc: true
    toc-depth: 2
    embed-resources: true
editor: visual
date: 08/27/2025
date-format: iso
---

-   PROJECT: Avian Interaction Database & Avian Meta-Network
-   AUTHORS: Phoebe Zarnetske, Pat Bills, Emily Parker
-   COLLABORATORS: Vincent Miele, Stephane Dray
-   DATA INPUT: Data entry CSV files in L0 folder
-   DATA OUTPUT: L0 data: AvianInteractionData_L0.csv
-   DATE: 20 Mar 2023 - AUGUST 2025

*Run date: `{r} Sys.Date()`*

## Ammendments and Corrections L0 to L1

For reviewing an L0 data file from data entry for corrections, see the script \[LINK\].

This will apply similar corrections to the file when stitched together to ensure it's as correct as possible.

### Setup.

This requires the script 'stitch.rmd' \[LINK\] to be run to create a stitched file to correct.

**The files paths used for this run are:**

```{r}
#| echo: false
#| warnings: false


# load in all required packages in function script
# optionally supress messages for noisey packages
suppressMessages(
  source(here::here('R/L0/L0_functions.R'))
)

# This uses functions in R/L0/L0_functions_files which also imports R/config.R
# which sets the locations of the data folders. 

file_paths <- get_file_paths() 
print(file_paths)
# for compatibility with code copied from previous version

L0_dir <- file_paths$L0
if(!dir.exists(L0_dir)) {
  print("can't find the L0 directory")
  print(L0_dir)
  stop()
}

```

## Reading in L0 file

**set L0 file location**

*update this to work on different files*

```{r}
# copy this file name from L0_stitch.rmd to use the same 
intxnsL0.filename <-"AvianInteractionData_L0_test.csv"

```

Full file path for this session:

```{r}

#| echo: false

intxnsL0.filepath <- file.path(file_paths$L0,intxnsL0.filename) 
print(intxnsL0.filepath)

```

```{r}
#| label: read_data
#| echo: false
if (file.exists(intxnsL0.filepath)) {
  intxnsL0.wide <- read.csv(intxnsL0.filepath)
  print(nrow(intxnsL0.wide))
  tibble(intxnsL0.wide)
} else {
  print("could not find path to this CSV")
}
```

## Wide to Long

Biw collapse multiple sources now spread across columns A, B, C, D into multiple rows, which will increase the total rows in the raw file.

```{r}
#| label: wide_to_long
#| echo: false

intxnsL0<- sources_wide_to_long(intxnsL0.wide)
```

New row count: `{r} nrow(intxnsL0)`

New row names:

`{r} names(intxnsL0)`

## Data Cleaning

???

this is what was in a PLZ file, but we shouldn't remove rows for this reason

```{r}
# Minor cleaning on int.raw: remove rows with NA in both columns of scientific names
intxnsL0 <-intxnsL0 [!with(intxnsL0 ,is.na(species1_scientific)& is.na(species2_scientific)),]
  
```

### set zero interactions to be zero

see L0_functions.R for list of interactions that should have 0,0

set these to 0,0, overwriting any errors.

```{r}
intxnsL0 <- fix_interaction_errors(intxnsL0)
```

### consistent use of 'unid'

Unid unid should be unid.

**TO-DO** finish this and add this to the stitching corrections

```{r}

# Code from L1 from PLZ to adapt to intxnsL0 df
# tidy up the species names
intxnsL0<- dplyr::mutate(intxnsL0,
      species1_scientific = ifelse(
        str_starts(species1_scientific, "unid."),  # Exception case
        str_replace(species1_scientific, "(unid.)s*(w+)", "1 U2"),
        str_to_sentence(species1_scientific)       # Regular case
      ),
      species1_scientific = str_replace(species1_scientific, "spp.", "sp.")
)

intxnsL0<- dplyr::mutate(intxnsL0,
      species2_scientific = ifelse(
        str_starts(species2_scientific, "unid."),  # Exception case
        str_replace(species2_scientific, "(unid.)s*(w+)", "1 U2"),
        str_to_sentence(species2_scientific)       # Regular case
      ),
      species1_scientific = str_replace(species1_scientific, "spp.", "sp.")
)
# tidy common_name
intxnsL0<- intxnsL0 %>% dplyr::mutate(
    species1_common = 
        stringr::str_trim(species1_common) %>%  # Start with the raw data
        stringr::str_to_title() %>%  # Capitalize each word
        stringr::str_replace_all("[Uu]nid ", "unid. ") %>%
        stringr::str_replace_all("Unid.", "unid.")
        , # add period to unids
    species2_common = 
        stringr::str_trim(species2_common) %>%  # Start with the raw data
        stringr::str_to_title() %>%  # Capitalize each word
        stringr::str_replace_all("[Uu]nid ", "unid. ") %>% # add period to unids
        stringr::str_replace_all("Unid.", "unid.")
)
```
